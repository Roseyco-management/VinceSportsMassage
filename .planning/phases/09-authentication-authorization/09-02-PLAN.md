---
phase: 09-authentication-authorization
plan: 02
type: execute
---

<objective>
Build the login user interface with email/password form and server actions for authentication.

Purpose: Create the entry point for admin users to authenticate. This plan implements the user-facing login page that calls the backend auth utilities from Plan 1.
Output: Working login page at /login with form validation, error handling, and redirect to /admin on success.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-authentication-authorization/09-01-SUMMARY.md
@src/lib/auth/session.ts
@src/lib/auth/roles.ts
@src/lib/supabase/client.ts
@src/lib/supabase/server.ts
@src/lib/validation.ts

**Available from Plan 1:**
- session.ts utilities (getSession, getUser, requireAuth)
- roles.ts utilities (isAdmin, requireAdmin)
- Middleware protecting /admin routes
- admin_users table in database

**UI components available:**
- shadcn/ui components (Card, Label, Input, Button, Alert)
- Existing form patterns from contact page
- Tailwind CSS utilities with cn() helper

**Established patterns:**
- Server Components by default, "use client" for interactivity
- Server actions with "use server" directive
- Zod validation for all user input
- Error messages via state in client components
- redirect() from "next/navigation" for server-side navigation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create login page with email/password form</name>
  <files>src/app/login/page.tsx, src/components/auth/login-form.tsx</files>
  <action>
Create login page structure split into Server Component (page) and Client Component (form):

**src/app/login/page.tsx** (Server Component):
- Default export page component
- Import and render LoginForm component
- Add metadata export: title "Admin Login", description "Sign in to access admin dashboard"
- Wrap form in Card component for consistent styling
- Center on page with flexbox (min-h-screen flex items-center justify-center)

**src/components/auth/login-form.tsx** (Client Component):
- "use client" directive at top
- Import shadcn/ui: Card, CardHeader, CardTitle, CardDescription, CardContent, Label, Input, Button, Alert
- React state for: email, password, error, isLoading
- Form with onSubmit handler that:
  1. Sets isLoading to true
  2. Calls loginAction (imported from ../app/login/actions)
  3. Handles response - if error, set error state; if success, redirect happens server-side
  4. Sets isLoading to false
- Email input: type="email", required, autocomplete="email"
- Password input: type="password", required, autocomplete="current-password"
- Submit button: disabled when isLoading, shows "Signing in..." when loading
- Error Alert component shown conditionally when error state exists
- Use Tailwind classes matching existing site style (cyan accent colors)

Follow shadcn/ui patterns from existing components. Use cn() utility for conditional classes.

AVOID: Don't use client-side supabase.auth.signInWithPassword (security risk - use server actions). Don't store tokens in localStorage (Supabase cookies handle this). Don't validate on client only (server validation is required).
  </action>
  <verify>Files exist, page renders at /login, form has email/password fields and submit button, TypeScript validates</verify>
  <done>Login page displays correctly, form is interactive, no TypeScript/build errors</done>
</task>

<task type="auto">
  <name>Task 2: Create server action for login authentication</name>
  <files>src/app/login/actions.ts</files>
  <action>
Create server actions for authentication:

**src/app/login/actions.ts:**
- "use server" directive at top
- Import createClient from "@/lib/supabase/server"
- Import redirect from "next/navigation"
- Import z from "zod"

Create loginAction(formData: FormData):
1. Extract email and password from formData
2. Validate with Zod schema:
   ```typescript
   const schema = z.object({
     email: z.string().email("Valid email required"),
     password: z.string().min(6, "Password must be at least 6 characters")
   })
   ```
3. If validation fails, return { error: "Invalid input" }
4. Create server Supabase client
5. Call supabase.auth.signInWithPassword({ email, password })
6. If auth error, return { error: error.message }
7. If success, check if user is admin by querying admin_users table
8. If not admin, sign out and return { error: "Unauthorized - admin access only" }
9. If admin, call redirect("/admin") - this will end the function
10. Wrap in try-catch, return { error: "Login failed" } on unexpected errors

Type return as { error?: string } for the form to handle.

Use structured logging for auth failures (do NOT log passwords):
```typescript
logger.warn("Login failed", { email, reason: "invalid credentials" })
```

AVOID: Don't return detailed error messages that leak user existence (generic "Invalid credentials" is fine). Don't log sensitive data. Don't use cookies directly (Supabase handles session cookies automatically).
  </action>
  <verify>cat src/app/login/actions.ts shows loginAction with Zod validation and proper error handling</verify>
  <done>Server action exists, validates input, calls Supabase auth, checks admin role, redirects on success</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Login page with email/password form and authentication flow</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/login
    3. Test invalid email format: Should show validation error
    4. Test incorrect credentials: Should show "Invalid credentials" error
    5. Test valid admin credentials (from Plan 1): Should redirect to /admin
    6. After successful login, try visiting /login again: May redirect to /admin automatically (already logged in)
    7. Open browser DevTools > Application > Cookies: Should see Supabase auth cookies set
    8. Test non-admin user (if you created one): Should see "Unauthorized - admin access only"
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Login page accessible at /login
- [ ] Form validation works (Zod schema)
- [ ] Invalid credentials show error message
- [ ] Valid admin login redirects to /admin
- [ ] Non-admin users are rejected
- [ ] No TypeScript errors: npm run build succeeds
- [ ] Middleware still protects /admin (test in incognito window)
</verification>

<success_criteria>

- All tasks completed
- Login page renders correctly with form
- Authentication flow works end-to-end
- Server action validates input and calls Supabase Auth
- Admin role verification prevents non-admin access
- Successful login redirects to /admin dashboard
- No console errors or TypeScript issues
- Ready for admin dashboard shell (Plan 3)
  </success_criteria>

<output>
After completion, create `.planning/phases/09-authentication-authorization/09-02-SUMMARY.md`:

---
phase: 09-authentication-authorization
plan: 02
type: execute
subsystem: auth-ui
requires: [9]
provides: ["login-page", "login-action", "auth-flow"]
affects: [9]
tech-stack:
  added: ["Login form component", "Server action authentication"]
  patterns: ["Form with server actions", "Client/server component split for forms", "Zod validation in server actions"]
key-decisions:
  - "Separate page (Server Component) from form (Client Component) for optimal bundle size"
  - "Server action performs both Supabase auth AND admin role verification"
  - "Generic error messages to avoid leaking user existence"
  - "Auto-redirect to /admin on successful authentication"
key-files:
  - "src/app/login/page.tsx"
  - "src/app/login/actions.ts"
  - "src/components/auth/login-form.tsx"
patterns-established:
  - "Server action + client form pattern for authentication"
  - "Zod validation before Supabase calls"
  - "Role verification during login (not just at protected routes)"
---

# Phase 9 Plan 2: Login UI & Authentication Flow Summary

**[One-liner about what shipped]**

## Accomplishments

- [List key achievements]

## Files Created/Modified

- [File paths with descriptions]

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 09-03-PLAN.md (Admin Dashboard Shell with Layout & Logout)
</output>
