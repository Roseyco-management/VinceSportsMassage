---
phase: 03-environment-configuration-management
plan: 01
type: execute
---

<objective>
Extract hardcoded values to environment variables and implement comprehensive environment validation with proper error handling.

Purpose: Eliminate hardcoded configuration values to enable environment-specific deployments (staging vs production) and prevent runtime crashes from missing environment variables.

Output: Validated environment configuration utility, updated components using environment variables, updated .env.local.example with new variables.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-security-hardening/01-01-SUMMARY.md
@.planning/phases/02-input-validation-error-handling/02-01-SUMMARY.md

**Tech stack available:** DOMPurify 3.3.1, jsdom 27.4.0, Zod 3.24.1, crypto (built-in)
**Established patterns:** Zod schema validation (from Phase 2), defensive null checks (from Phase 1-2), structured logging

**Constraining decisions:**
- Phase 2: Simple structured logging (no winston/pino) - use existing logger utility
- Phase 2: Zod for validation - extend pattern to environment variables
- Phase 1: Defensive null checks - apply to all env var access

**Issues being addressed:**
- CONCERNS.md #8: Hardcoded Values (Calendly URL params, YouTube video ID)
- CONCERNS.md #4: Environment Variable Security (non-null assertions without validation)
- CONCERNS.md #22: Supabase Type Non-Null Assertions

**Context from CONCERNS.md:**
Hardcoded values identified:
- YouTube video ID: `O3jvJ8w6OOY` in src/components/sections/hero.tsx:16
- Calendly URL parameters: `?hide_gdpr_banner=1&background_color=ffffff&text_color=1e293b&primary_color=0891b2` in src/app/(marketing)/booking/booking-page.tsx:203
- Contact info in src/lib/constants.ts (phone, email, address) - KEEP IN CODE (not environment-specific, part of site content)

Existing environment variable usage:
- src/lib/supabase/client.ts: Uses non-null assertions on NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY
- src/lib/supabase/server.ts: Uses non-null assertions on same variables plus SUPABASE_SERVICE_ROLE_KEY
- src/app/api/blog/route.ts: Already validates N8N_WEBHOOK_SECRET (defensive checks added in Phase 1)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment validation utility with Zod</name>
  <files>src/lib/env.ts, .env.local.example</files>
  <action>
Create `src/lib/env.ts` that validates all environment variables at module load time using Zod. Follow Phase 2 validation patterns but validate at app startup (not per-request).

Schema should validate:
- NEXT_PUBLIC_SUPABASE_URL (url format)
- NEXT_PUBLIC_SUPABASE_ANON_KEY (string, min length 1)
- SUPABASE_SERVICE_ROLE_KEY (string, min length 1)
- N8N_WEBHOOK_SECRET (string, min length 1)
- NEXT_PUBLIC_YOUTUBE_VIDEO_ID (optional string, defaults to 'O3jvJ8w6OOY')
- NEXT_PUBLIC_CALENDLY_PARAMS (optional string, defaults to '?hide_gdpr_banner=1&background_color=ffffff&text_color=1e293b&primary_color=0891b2')

Pattern: Create Zod schema, parse process.env with .parse() (throws on failure), export typed object.

Add new environment variables to .env.local.example with documentation comments.

Why validate at startup: Fail fast on misconfiguration rather than at runtime. Server-side variables validated server-side, client-side variables (NEXT_PUBLIC_*) validated both server and client.

Why defaults for YouTube/Calendly: These are presentation configuration, not secrets. Reasonable defaults prevent deployment failures while still allowing customization per environment.
  </action>
  <verify>
npx tsc --noEmit passes (type checking confirms env.ts exports correct types)
Test: Comment out required env var in .env.local, npm run build should fail with clear Zod validation error
Test: Restore env var, npm run build succeeds
  </verify>
  <done>
- src/lib/env.ts exports validated environment object with correct TypeScript types
- Zod schema validates all required environment variables
- Optional variables (YouTube ID, Calendly params) have sensible defaults
- .env.local.example documents all variables including new ones
- Build fails fast with clear error message when required variables missing
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace non-null assertions with validated environment imports</name>
  <files>src/lib/supabase/client.ts, src/lib/supabase/server.ts, src/app/api/blog/route.ts</files>
  <action>
Replace all `process.env.VAR!` non-null assertions with imports from `src/lib/env.ts`.

Changes:
1. src/lib/supabase/client.ts:
   - Import { env } from '@/lib/env'
   - Replace process.env.NEXT_PUBLIC_SUPABASE_URL! with env.NEXT_PUBLIC_SUPABASE_URL
   - Replace process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY! with env.NEXT_PUBLIC_SUPABASE_ANON_KEY

2. src/lib/supabase/server.ts:
   - Import { env } from '@/lib/env'
   - Replace all process.env non-null assertions with env.VARIABLE_NAME

3. src/app/api/blog/route.ts:
   - Import { env } from '@/lib/env'
   - Replace process.env.N8N_WEBHOOK_SECRET access with env.N8N_WEBHOOK_SECRET
   - Remove the manual null check (lines 42-52) since env.ts already validates this at startup
   - Keep the timing-safe comparison logic unchanged

Why remove manual checks in blog route: The env.ts validation at startup ensures N8N_WEBHOOK_SECRET exists. The manual null check is now redundant. If the app starts, the secret exists.

Why keep defensive checks at startup only: Fail fast on app boot (clear error, no partial functionality). Don't revalidate on every request (performance, redundant).
  </action>
  <verify>
npx tsc --noEmit passes
npm run build succeeds
grep -r "process\.env\." src/lib/supabase/ src/app/api/blog/route.ts returns 0 matches (all replaced)
  </verify>
  <done>
- All non-null assertions replaced with validated env imports
- No direct process.env access in modified files
- TypeScript compilation passes
- Build succeeds without warnings
  </done>
</task>

<task type="auto">
  <name>Task 3: Extract hardcoded values to environment variables</name>
  <files>src/components/sections/hero.tsx, src/app/(marketing)/booking/booking-page.tsx</files>
  <action>
Replace hardcoded configuration values with environment variables from validated env object.

Changes:
1. src/components/sections/hero.tsx:
   - Import { env } from '@/lib/env'
   - Replace hardcoded video ID 'O3jvJ8w6OOY' with env.NEXT_PUBLIC_YOUTUBE_VIDEO_ID in both places (line 16 appears twice in the URL)
   - Keep URL construction pattern: `https://www.youtube.com/embed/${env.NEXT_PUBLIC_YOUTUBE_VIDEO_ID}?autoplay=1&mute=1&loop=1&playlist=${env.NEXT_PUBLIC_YOUTUBE_VIDEO_ID}&controls=0&showinfo=0&rel=0&modestbranding=1&playsinline=1&enablejsapi=1`

2. src/app/(marketing)/booking/booking-page.tsx:
   - Import { env } from '@/lib/env'
   - Replace hardcoded query params `?hide_gdpr_banner=1&background_color=ffffff&text_color=1e293b&primary_color=0891b2` with env.NEXT_PUBLIC_CALENDLY_PARAMS
   - Keep siteConfig.calendly for base URL: `${siteConfig.calendly}${env.NEXT_PUBLIC_CALENDLY_PARAMS}`

Why keep contact info in constants.ts: Phone, email, address are site content (not configuration). They're displayed in UI, used in Schema.org markup, part of the site's identity. Not environment-specific. These should NOT be environment variables.

Why NEXT_PUBLIC_ prefix for new vars: These are used in client-side components (hero.tsx uses "use client", booking-page.tsx has client-side iframe). Next.js requires NEXT_PUBLIC_ prefix for variables exposed to browser.
  </action>
  <verify>
npm run build succeeds
Visit http://localhost:3000/ in dev mode - hero video background plays correctly
Visit http://localhost:3000/booking - Calendly widget loads with correct styling
grep -n "O3jvJ8w6OOY" src/components/sections/hero.tsx returns 0 matches
grep -n "hide_gdpr_banner" src/app/(marketing)/booking/booking-page.tsx returns 0 matches
  </verify>
  <done>
- YouTube video ID extracted to NEXT_PUBLIC_YOUTUBE_VIDEO_ID environment variable
- Calendly parameters extracted to NEXT_PUBLIC_CALENDLY_PARAMS environment variable
- Both components import and use validated env object
- No hardcoded configuration values remain in hero.tsx or booking-page.tsx
- Video background and Calendly widget render correctly with environment values
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build succeeds without errors or warnings
- [ ] npx tsc --noEmit passes (TypeScript strict mode)
- [ ] All process.env non-null assertions removed from Supabase clients and blog API
- [ ] Environment validation throws clear error when required variables missing
- [ ] YouTube video loads correctly on homepage
- [ ] Calendly widget loads correctly on booking page
- [ ] No hardcoded YouTube video ID or Calendly parameters in components
- [ ] .env.local.example documents all environment variables
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Environment variable validation implemented with Zod following Phase 2 patterns
- Non-null assertions eliminated from all Supabase clients and API routes
- Hardcoded configuration values (YouTube ID, Calendly params) extracted to environment
- Build fails fast with clear error message when environment misconfigured
- Zero breaking changes to functionality (video and Calendly work identically)
</success_criteria>

<output>
After completion, create `.planning/phases/03-environment-configuration-management/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Environment & Configuration Management Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 3 complete. Ready for Phase 4: Accessibility Remediation

[Any warnings or blockers for next phase]
</output>
