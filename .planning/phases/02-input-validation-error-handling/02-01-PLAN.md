---
phase: 02-input-validation-error-handling
plan: 01
type: execute
---

<objective>
Implement comprehensive Zod schema validation for blog API and replace console.error with structured logging utility.

Purpose: Eliminate data validation gaps and improve error observability for production debugging. Prevents invalid payloads from reaching database and enables proper error tracking.
Output: Type-safe API validation with Zod schemas, structured logging abstraction replacing all console.error calls, error handling for cache revalidation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-security-hardening/01-01-SUMMARY.md
@.planning/phases/01-critical-security-hardening/01-02-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
@/Users/baileybarry/VinceSportsMassage/src/app/api/blog/route.ts

**Tech stack available:**
- DOMPurify + jsdom (HTML sanitization)
- crypto.timingSafeEqual (timing-safe comparison)

**Established patterns:**
- Server-side utilities in src/lib/ (sanitize.ts, webhook-auth.ts)
- Defensive null checks with fail-closed behavior
- NextResponse.json for API responses
- Try-catch with specific error responses

**Constraining decisions:**
- Zod selected for input validation (PROJECT.md decision)
- Maintain n8n webhook compatibility (identical response format)
- No breaking changes to API contract

**Issues being addressed:**
- MEDIUM: No input validation beyond title/content check
- MEDIUM: console.error doesn't provide structured logging for production
- LOW: Cache revalidation can crash if paths invalid
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Zod schema validation for blog POST endpoint</name>
  <files>src/lib/validation.ts, src/app/api/blog/route.ts, package.json</files>
  <action>
1. Install Zod: `npm install zod`
2. Create src/lib/validation.ts with BlogPostPayload schema:
   - Required: title (string, min 1), content (string, min 1)
   - Optional: slug, excerpt, imageUrl/featured_image, metaDescription/meta_description, keywords/meta_keywords (array), author, publish (boolean), executionId/n8n_execution_id
   - Support both camelCase (n8n sends) and snake_case (legacy) field names
   - Use z.string().min(1) for required strings (not just z.string())
   - Use z.array(z.string()) for keywords with .optional()
3. Update POST handler in route.ts:
   - Import schema from validation.ts
   - Replace manual validation with schema.safeParse(body)
   - If !result.success, return 400 with result.error.issues mapped to readable format
   - Use result.data for type-safe access to validated fields
4. Keep all existing logic (slug generation, duplicate check, auto_generated flag)
5. DO NOT change response format (n8n compatibility requirement)
  </action>
  <verify>npm run build succeeds with no TypeScript errors</verify>
  <done>Zod validates all blog POST payloads, returns 400 with detailed errors for invalid data, TypeScript infers correct types from schema</done>
</task>

<task type="auto">
  <name>Task 2: Create structured logging utility and replace console.error</name>
  <files>src/lib/logger.ts, src/app/api/blog/route.ts</files>
  <action>
1. Create src/lib/logger.ts with simple structured logging abstraction:
   - Export logger object with methods: error(message, context?), warn(message, context?), info(message, context?)
   - Use JSON.stringify for context objects (simple, no dependencies)
   - Format: `[LEVEL] timestamp - message | context: {...}`
   - Include timestamp with new Date().toISOString()
   - Use console.error/warn/log under the hood (don't add winston/pino - keep it simple)
2. Update route.ts to replace all 5 console.error calls:
   - Line 42: Missing webhook secret → logger.error("Missing webhook secret", { hasExpected: !!expectedSecret, hasReceived: !!webhookSecret })
   - Line 51: Invalid webhook secret → logger.error("Invalid webhook secret")
   - Line 112: Database insert error → logger.error("Database insert failed", { error: error.message, title: body.title })
   - Line 153: Unexpected POST error → logger.error("Unexpected error in blog POST", { error })
   - Line 184: GET query error → logger.error("Database query failed", { error: error.message, status, limit, offset })
   - Line 196: Unexpected GET error → logger.error("Unexpected error in blog GET", { error })
3. Keep error responses identical (n8n compatibility)
  </action>
  <verify>npm run build succeeds, all logger calls have proper context objects</verify>
  <done>All console.error replaced with logger.error, structured logs include context for debugging, no functionality changes</done>
</task>

<task type="auto">
  <name>Task 3: Add error handling for cache revalidation</name>
  <files>src/app/api/blog/route.ts</files>
  <action>
1. Wrap revalidatePath calls (lines 139-140) in try-catch:
   ```typescript
   try {
     revalidatePath("/blog")
     revalidatePath(`/blog/${data.slug}`)
   } catch (error) {
     // Log but don't fail the request - post was created successfully
     logger.warn("Cache revalidation failed", {
       error,
       slug: data.slug,
       message: "Post created but cache not refreshed"
     })
   }
   ```
2. Rationale: revalidatePath can fail if paths are invalid or Next.js cache unavailable. Post creation succeeded, so warn but don't throw.
  </action>
  <verify>npm run build succeeds, TypeScript compilation passes</verify>
  <done>Cache revalidation wrapped in try-catch, logs warning on failure, doesn't crash POST request if revalidation fails</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors or warnings
- [ ] TypeScript compilation passes with strict mode
- [ ] Zod schema validates blog POST payloads correctly
- [ ] All console.error calls replaced with logger.error
- [ ] Cache revalidation has error handling
- [ ] n8n webhook response format unchanged
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Zod validation active for blog API POST endpoint
- Structured logging utility created and used throughout
- Cache revalidation failure doesn't crash API
- No breaking changes to n8n integration
- No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/02-input-validation-error-handling/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Input Validation & Structured Logging Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]
- [Key outcome 3]

## Files Created/Modified

- `src/lib/validation.ts` - Created Zod schema for blog POST validation
- `src/lib/logger.ts` - Created structured logging utility
- `src/app/api/blog/route.ts` - Updated with Zod validation and structured logging
- `package.json` - Added zod dependency

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 2 complete. Ready for Phase 3: Environment & Configuration Management
</output>
