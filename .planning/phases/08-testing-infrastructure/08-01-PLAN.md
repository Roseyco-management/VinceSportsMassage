---
phase: 08-testing-infrastructure
plan: 01
type: execute
---

<objective>
Set up Vitest testing infrastructure and add tests for critical security paths (blog API webhook authentication and slug generation logic).

Purpose: Prevent regressions in security-critical code paths through automated testing. Blog API webhook is the primary attack surface (handles external input, creates database records).
Output: Configured Vitest with React Testing Library, passing tests for webhook authentication and slug generation, test script in package.json
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md
@.planning/codebase/STACK.md

# Auto-selected based on dependency graph:
@.planning/phases/01-critical-security-hardening/01-01-SUMMARY.md
@.planning/phases/01-critical-security-hardening/01-02-SUMMARY.md
@.planning/phases/02-input-validation-error-handling/02-01-SUMMARY.md
@.planning/phases/07-type-safety-enhancement/07-01-SUMMARY.md

# Key files to test:
@src/app/api/blog/route.ts
@src/lib/webhook-auth.ts
@src/lib/validation.ts

**Tech stack available:** DOMPurify, jsdom, crypto (built-in), Zod, structured logging
**Established patterns:**
- Security hardening with timing-safe comparisons
- Zod schema validation for API payloads
- Structured logging for errors
- Type-safe API responses

**Constraining decisions:**
- Phase 1: DOMPurify for sanitization, crypto.timingSafeEqual for webhook auth
- Phase 2: Zod for validation, simple structured logging (no external logger)
- Phase 7: Explicit TypeScript response types for API routes

**Critical security paths to test:**
1. Webhook secret verification (timing-safe comparison) - prevents unauthorized blog post creation
2. Slug generation logic - prevents data corruption and URL collisions
3. Zod validation schema - ensures malformed payloads are rejected
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Vitest with React Testing Library</name>
  <files>vitest.config.ts, vitest.setup.ts, package.json</files>
  <action>
Install test dependencies:
```bash
npm install -D vitest @testing-library/react @testing-library/jest-dom @vitejs/plugin-react jsdom @types/node
```

Create vitest.config.ts:
- Use @vitejs/plugin-react for JSX/TSX support
- Set environment to "jsdom" for DOM testing
- Enable globals: true for describe/it/expect without imports
- Set setupFiles to "./vitest.setup.ts"
- Configure path alias "@" to resolve to "./src" (matches tsconfig.json)

Create vitest.setup.ts:
- Import "@testing-library/jest-dom" for DOM matchers
- Import cleanup from @testing-library/react
- Register afterEach(cleanup) to reset between tests

Add to package.json scripts:
- "test": "vitest"
- "test:ui": "vitest --ui"
- "test:coverage": "vitest --coverage"

Verify with empty test run: npm test (should pass with 0 tests)
  </action>
  <verify>npm test exits with code 0 showing "No test files found"</verify>
  <done>Vitest configured, setup file created, test script runs successfully</done>
</task>

<task type="auto">
  <name>Task 2: Write tests for webhook authentication and slug generation</name>
  <files>src/app/api/blog/__tests__/route.test.ts, src/lib/__tests__/slug.test.ts</files>
  <action>
Create src/app/api/blog/__tests__/route.test.ts to test webhook authentication:

Test cases for webhook secret verification:
1. Missing webhook secret header → 401 Unauthorized
2. Invalid webhook secret → 401 Unauthorized
3. Valid webhook secret with minimal payload → should process (focus on auth, not full flow)

Mock Supabase client using vi.mock("@supabase/supabase-js"):
- Mock createClient to return object with from() chain
- Keep tests focused on authentication logic, not database operations

Mock environment variables using vi.stubEnv():
- Set N8N_WEBHOOK_SECRET to known test value
- Set other required env vars (SUPABASE_URL, etc.)

Create src/lib/__tests__/slug.test.ts to test slug generation:

Extract generateSlug function from route.ts to testable location first (move to src/lib/slug.ts), then import and test:

Test cases:
1. Basic title → lowercase with hyphens ("Hello World" → "hello-world")
2. Special characters removed ("Hello! World?" → "hello-world")
3. Multiple spaces collapsed ("Hello   World" → "hello-world")
4. Leading/trailing hyphens removed ("-hello-world-" → "hello-world")
5. Numbers preserved ("Hello 2024 World" → "hello-2024-world")
6. Empty string → empty string (edge case)

Use describe/it/expect pattern. Keep tests simple and focused.

IMPORTANT: Do NOT test full POST flow with database operations - too complex for initial setup. Focus on authentication and slug generation logic only.
  </action>
  <verify>npm test shows all tests passing with clear output</verify>
  <done>Tests written for webhook auth validation and slug generation, all passing</done>
</task>

<task type="auto">
  <name>Task 3: Add test for Zod validation schema</name>
  <files>src/lib/__tests__/validation.test.ts</files>
  <action>
Create src/lib/__tests__/validation.test.ts to test blogPostPayloadSchema:

Test cases for valid inputs:
1. Minimal valid payload (title + content) → success
2. Full payload with all optional fields → success
3. CamelCase field names (backward compatibility) → success
4. Snake_case field names → success

Test cases for invalid inputs:
1. Missing title → validation error
2. Missing content → validation error
3. Empty title → validation error
4. Empty content → validation error
5. Invalid field types (title as number, etc.) → validation error

Use blogPostPayloadSchema.safeParse() and check result.success boolean.
For errors, verify result.error.issues contains expected validation messages.

Keep tests focused on schema behavior, not API route logic.
  </action>
  <verify>npm test shows validation tests passing alongside other tests</verify>
  <done>Zod schema tests written and passing, coverage of critical validation paths</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm test` runs successfully and all tests pass
- [ ] `npm run build` still succeeds (no TypeScript errors from test files)
- [ ] Test files follow convention: `__tests__/*.test.ts`
- [ ] All 3 critical paths covered: webhook auth, slug generation, Zod validation
- [ ] Tests are focused and maintainable (no complex mocking)
</verification>

<success_criteria>

- All tasks completed
- Vitest configured with jsdom environment
- Test script in package.json works
- Tests for webhook authentication pass (reject unauthorized, accept valid)
- Tests for slug generation pass (cover edge cases)
- Tests for Zod validation schema pass (valid/invalid inputs)
- Build succeeds with no errors
- Zero test coverage → measurable coverage for critical security paths
</success_criteria>

<output>
After completion, create `.planning/phases/08-testing-infrastructure/08-01-SUMMARY.md`:

# Phase 8 Plan 1: Testing Infrastructure Summary

**[Substantive one-liner - e.g., "Vitest with React Testing Library configured, tests for webhook auth and slug generation securing critical API paths"]**

## Performance

- **Duration:** [time]
- **Started:** [ISO timestamp]
- **Completed:** [ISO timestamp]
- **Tasks:** 3
- **Files modified:** [count]

## Accomplishments

- Vitest testing infrastructure configured with jsdom and React Testing Library
- Tests for webhook secret verification (timing-safe comparison)
- Tests for slug generation logic (prevents URL collisions)
- Tests for Zod validation schema (input sanitization)

## Task Commits

1. **Task 1: Install and configure Vitest** - `abc123f` (chore)
2. **Task 2: Webhook auth and slug tests** - `def456g` (test)
3. **Task 3: Zod validation tests** - `hij789k` (test)

**Plan metadata:** `lmn012o` (docs: complete testing infrastructure plan)

## Files Created/Modified

- `vitest.config.ts` - Vitest configuration with React plugin and jsdom
- `vitest.setup.ts` - Test setup with @testing-library/jest-dom
- `src/app/api/blog/__tests__/route.test.ts` - Webhook authentication tests
- `src/lib/__tests__/slug.test.ts` - Slug generation tests
- `src/lib/__tests__/validation.test.ts` - Zod schema validation tests
- `src/lib/slug.ts` - Extracted slug generation utility (testable)
- `package.json` - Test scripts added

## Decisions Made

[Key decisions with rationale, or "None - followed plan as specified"]

## Deviations from Plan

[If no deviations: "None - plan executed exactly as written"]

[If deviations: document using deviation rules from execute-phase.md]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

All 8 phases complete. Testing infrastructure in place to prevent security regressions.

---
*Phase: 08-testing-infrastructure*
*Plan: 1 of 1*
*Completed: [date]*
</output>
